{% extends "base.html" %}
{% block content %}

  <!-- Filtros / busca -->
  <form method="get" class="row g-2 align-items-end">
    <div class="col-12 col-md-4">
      <label class="form-label">Buscar</label>
      <input type="text" class="form-control" name="q" placeholder="Nome ou SKU" value="{{ q or '' }}">
    </div>
    <div class="col-6 col-md-3">
      <label class="form-label">Categoria</label>
      <select class="form-select" name="cat">
        <option value="0">Todas</option>
        {% for c in cats %}
          <option value="{{ c.id }}" {{ 'selected' if cat_sel==c.id else '' }}>{{ c.name }}</option>
        {% endfor %}
      </select>
    </div>
    <div class="col-6 col-md-3">
      <label class="form-label">Fornecedor</label>
      <select class="form-select" name="sup">
        <option value="0">Todos</option>
        {% for s in sups %}
          <option value="{{ s.id }}" {{ 'selected' if sup_sel==s.id else '' }}>{{ s.name }}</option>
        {% endfor %}
      </select>
    </div>
    <div class="col-6 col-md-2">
      <label class="form-label">Ordenar</label>
      <select class="form-select" name="sort">
        <option value="name"  {{ 'selected' if sort=='name'  else '' }}>Nome</option>
        <option value="sku"   {{ 'selected' if sort=='sku'   else '' }}>SKU</option>
        <option value="qty"   {{ 'selected' if sort=='qty'   else '' }}>Quantidade</option>
        <option value="price" {{ 'selected' if sort=='price' else '' }}>Preço</option>
        <option value="margin" {{ 'selected' if sort=='margin' else '' }}>Margem</option>
      </select>
    </div>
    <div class="col-6 col-md-2">
      <label class="form-label">Direção</label>
      <select class="form-select" name="dir">
        <option value="asc"  {{ 'selected' if direction=='asc'  else '' }}>Asc</option>
        <option value="desc" {{ 'selected' if direction=='desc' else '' }}>Desc</option>
      </select>
    </div>
    <div class="col-12 col-md-2">
      <label class="form-label">&nbsp;</label>
      <button class="btn btn-primary w-100" type="submit"><i class="bi bi-funnel"></i> Aplicar</button>
    </div>
  </form>

  <div class="d-flex justify-content-between align-items-center mt-3">
    <h5 class="mb-0">Total de produtos: <span class="badge text-bg-secondary">{{ total }}</span></h5>
    {% if current_user.role in ['admin','operador'] %}
      <a class="btn btn-success" href="{{ url_for('novo_produto') }}"><i class="bi bi-plus-circle"></i> Cadastrar</a>
    {% endif %}
  </div>

  {% if not produtos %}
    <div class="alert alert-info mt-3"><i class="bi bi-info-circle"></i> Nenhum produto cadastrado.</div>
  {% else %}
    <div class="table-responsive mt-3">
      <table class="table table-hover align-middle">
        <thead class="table-light">
          <tr>
            <th>ID</th><th>SKU</th><th>Nome</th><th>Categoria</th><th>Fornecedor</th>
            <th>Un</th><th>Preço</th><th>CMP</th><th>Margem</th><th>Qtd</th><th>Mín</th><th class="text-end">Ações</th>
          </tr>
        </thead>
        <tbody>
          {% for p in produtos %}
          <tr>
            <td>{{ p.id }}</td>
            <td><span class="text-secondary">{{ p.sku }}</span></td>
            <td><a class="link-underline link-underline-opacity-0" href="{{ url_for('produto', pid=p.id) }}">{{ p.name }}</a></td>
            <td>{{ p.category or '-' }}</td>
            <td>{{ p.supplier or '-' }}</td>
            <td>{{ p.unit }}</td>
            <td>R$ {{ p.price }}</td>
            <td>R$ {{ p.avg_cost }}</td>
            <td>R$ {{ p.margin_abs }} ({{ p.margin_pct }}%)</td>
            <td class="{{ 'qty-warn' if p.current_qty|float <= p.min_qty|float else 'qty-ok' }}">{{ p.current_qty }}</td>
            <td>{{ p.min_qty }}</td>
            <td class="text-end table-actions">
              {% if current_user.role in ['admin','operador'] %}
                <form class="d-inline" method="post" action="{{ url_for('entrada', pid=p.id) }}">
                  <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                  <div class="input-group input-group-sm" style="width: 310px; max-width: 100%;">
                    <input class="form-control" type="number" name="qtd" step="1" min="1" placeholder="+Qtd">
                    <input class="form-control" type="number" step="0.01" name="unit_cost" placeholder="Custo">
                    <select class="form-select" name="reason">
                      <option>Compra</option><option>Devolução</option><option>Ajuste</option><option>Outro</option>
                    </select>
                    <button class="btn btn-outline-success" type="submit" title="Entrada"><i class="bi bi-box-arrow-in-down"></i></button>
                  </div>
                </form>
                <form class="d-inline" method="post" action="{{ url_for('saida', pid=p.id) }}">
                  <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                  <div class="input-group input-group-sm mt-1" style="width: 260px; max-width: 100%;">
                    <input class="form-control" type="number" name="qtd" step="1" min="1" placeholder="-Qtd">
                    <select class="form-select" name="reason">
                      <option>Venda</option><option>Perda</option><option>Ajuste</option><option>Outro</option>
                    </select>
                    <button class="btn btn-outline-danger" type="submit" title="Saída"><i class="bi bi-box-arrow-up"></i></button>
                  </div>
                </form>
                <a class="btn btn-outline-secondary btn-sm mt-1" href="{{ url_for('editar_produto', pid=p.id) }}"><i class="bi bi-pencil-square"></i></a>
                {% if current_user.role == 'admin' %}
                  <form class="d-inline" method="post" action="{{ url_for('excluir_produto', pid=p.id) }}" onsubmit="return confirm('Excluir este produto e seu histórico?');">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                    <button class="btn btn-outline-danger btn-sm mt-1" type="submit"><i class="bi bi-trash3"></i></button>
                  </form>
                {% endif %}
              {% else %}
                <span class="text-secondary">somente leitura</span>
              {% endif %}
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>

    <!-- Paginação -->
    <nav>
      <ul class="pagination justify-content-center">
        {% if page > 1 %}
          <li class="page-item"><a class="page-link" href="{{ url_for('index', q=q, sort=sort, dir=direction, page=page-1, cat=cat_sel, sup=sup_sel) }}">« Anterior</a></li>
        {% else %}<li class="page-item disabled"><span class="page-link">« Anterior</span></li>{% endif %}
        <li class="page-item disabled"><span class="page-link">Página {{ page }} de {{ pages }}</span></li>
        {% if page < pages %}
          <li class="page-item"><a class="page-link" href="{{ url_for('index', q=q, sort=sort, dir=direction, page=page+1, cat=cat_sel, sup=sup_sel) }}">Próxima »</a></li>
        {% else %}<li class="page-item disabled"><span class="page-link">Próxima »</span></li>{% endif %}
      </ul>
    </nav>
  {% endif %}
{% endblock %}
